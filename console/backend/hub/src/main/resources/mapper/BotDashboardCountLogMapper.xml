<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.iflytek.astron.console.hub.mapper.BotDashboardCountLogMapper">

    <!-- Get bot summary statistics -->
    <select id="selectSummaryStats" resultType="com.iflytek.astron.console.hub.dto.publish.BotSummaryStatsVO">
        SELECT 
            COALESCE(SUM(token), 0) as totalTokens,
            COALESCE(COUNT(DISTINCT chat_id), 0) as totalChats,
            COALESCE(COUNT(DISTINCT uid), 0) as totalUsers,
            COALESCE(COUNT(*), 0) as totalMessages
        FROM bot_dashboard_count_log 
        WHERE bot_id = #{botId}
        <if test="uid != null">
            AND uid = #{uid}
        </if>
        <if test="spaceId != null">
            AND space_id = #{spaceId}
        </if>
    </select>

    <!-- Get bot time series statistics -->
    <select id="selectTimeSeriesStats" resultType="com.iflytek.astron.console.hub.dto.publish.BotTimeSeriesStatsVO">
        SELECT 
            create_time as date,
            COALESCE(COUNT(DISTINCT uid), 0) as userCount,
            COALESCE(SUM(token), 0) as tokenCount,
            COALESCE(COUNT(*), 0) as messageCount,
            COALESCE(COUNT(DISTINCT chat_id), 0) as chatCount
        FROM bot_dashboard_count_log 
        WHERE bot_id = #{botId}
        <if test="startDate != null">
            AND create_time >= #{startDate}
        </if>
        <if test="uid != null">
            AND uid = #{uid}
        </if>
        <if test="spaceId != null">
            AND space_id = #{spaceId}
        </if>
        GROUP BY create_time
        ORDER BY create_time ASC
    </select>

</mapper>
